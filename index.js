import { Client, GatewayIntentBits, EmbedBuilder } from "discord.js";
import "dotenv/config";
import fs from "fs";
import path from "path";

const ADMIN_ID = "934670194096345118";

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
  ],
});

client.once("ready", () => {
  console.log(`âœ… Logged in as ${client.user.tag}`);
});

// location of your data file
const filePath = path.join(process.cwd(), "accounts.json");

// ensure data structure exists
function loadData() {
  if (!fs.existsSync(filePath)) {
    const init = { normal: [], banned: [] };
    fs.writeFileSync(filePath, JSON.stringify(init, null, 2));
  }
  return JSON.parse(fs.readFileSync(filePath, "utf8"));
}
function saveData(data) {
  fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
}

client.on("messageCreate", async (message) => {
  if (message.author.bot) return;
  const content = message.content.trim();
  const data = loadData();

  // ----------------------------------------------------
  // USER HELP COMMAND
  // ----------------------------------------------------
  if (content === "$help" || content === "$mcfa help") {
    const embed = new EmbedBuilder()
      .setColor("#00FFAA")
      .setTitle("ðŸ§­ LoxYâ€¯Hubâ€¯Userâ€¯Help")
      .setDescription(
        "Here are the commands you can use:\n\n" +
          "ðŸ’ â€¯**$mcfaâ€¯gen**â€¯â†’â€¯Get a free MCFAâ€¯account (everyone can use)\n" +
          "ðŸ’ â€¯**$mcfaâ€¯banned**â€¯â†’â€¯Get a free *banned*â€¯Minecraftâ€¯account\n" +
          "ðŸ’ â€¯**$stock**â€¯â†’â€¯See how many accounts are left\n" +
          "ðŸ’ â€¯**$help**â€¯â†’â€¯Show this help message"
      )
      .setFooter({ text: "LoxYâ€¯Hubâ€¯â€¢â€¯Support your community â¤ï¸" });
    return message.reply({ embeds: [embed] });
  }

  // ----------------------------------------------------
  // ADMIN HELP COMMAND
  // ----------------------------------------------------
  if (content === "$adminhelp") {
    if (message.author.id !== ADMIN_ID)
      return message.reply("ðŸš«â€¯Only admin can use this command.");

    const embed = new EmbedBuilder()
      .setColor("#ff9933")
      .setTitle("ðŸ› â€¯LoxYâ€¯Hubâ€¯Adminâ€¯Help")
      .setDescription(
        "Adminâ€¯onlyâ€¯commands:\n\n" +
          "ðŸ”§â€¯**$mcfaâ€¯addâ€¯emailâ€¯password**â€¯â†’â€¯Addâ€¯normalâ€¯account\n" +
          "ðŸ”§â€¯**$mcfaâ€¯addâ€¯Minecraft_bannedâ€¯emailâ€¯password**â€¯â†’â€¯Addâ€¯bannedâ€¯account\n" +
          "ðŸ—‘â€¯**$mcfaâ€¯resetâ€¯banned**â€¯â†’â€¯Resetâ€¯allâ€¯bannedâ€¯accounts\n" +
          "ðŸ—‘â€¯**$mcfaâ€¯resetâ€¯mcfa**â€¯â†’â€¯Resetâ€¯allâ€¯normalâ€¯accounts"
      )
      .setFooter({ text: "Only ADMIN_ID can run these." });
    return message.reply({ embeds: [embed] });
  }

  // ----------------------------------------------------
  // STOCK SHOW
  // ----------------------------------------------------
  if (content === "$stock") {
    const total = data.normal.length;
    const banned = data.banned.length;
    const embed = new EmbedBuilder()
      .setColor("#0099ff")
      .setTitle("ðŸ“¦â€¯LoxYâ€¯Hubâ€¯Stock")
      .setDescription(
        `ðŸ§®â€¯**Normalâ€¯accounts:**â€¯${total}\n` +
          `ðŸš«â€¯**Bannedâ€¯accounts:**â€¯${banned}\n\n` +
          "Use **$mcfaâ€¯gen**â€¯orâ€¯**$mcfaâ€¯banned**â€¯toâ€¯getâ€¯one!"
      );
    return message.reply({ embeds: [embed] });
  }

  // ----------------------------------------------------
  // ANYONE: GENERATE NORMAL ACCOUNT
  // ----------------------------------------------------
  if (content === "$mcfa gen") {
    const account = data.normal.shift();
    if (!account)
      return message.reply("âŒâ€¯Noâ€¯normalâ€¯accountsâ€¯available!");

    saveData(data);

    const embed = new EmbedBuilder()
      .setColor("#00FFAA")
      .setTitle("ðŸŽâ€¯Yourâ€¯Freeâ€¯MCFAâ€¯Account")
      .setDescription(
        `Heyâ€¯**${message.author.username}**,â€¯hereâ€™sâ€¯yourâ€¯account:\n\n` +
          `>â€¯ðŸ“§â€¯**Email:**â€¯\`${account.email}\`\n` +
          `>â€¯ðŸ”â€¯**Password:**â€¯\`${account.password}\`\n\n` +
          "Enjoy!â€¯Rememberâ€¯toâ€¯keep it private and use responsibly."
      )
      .setFooter({ text: "Generated byâ€¯LoxYâ€¯Hub" });

    await message.author.send({ embeds: [embed] }).catch(() =>
      message.reply("ðŸ“¬â€¯Couldnâ€™tâ€¯DMâ€¯youâ€¯â€”â€¯enableâ€¯DMs!")
    );
    return message.reply("ðŸ“©â€¯Checkâ€¯yourâ€¯DMsâ€¯forâ€¯theâ€¯accountâ€¯details!");
  }

  // ----------------------------------------------------
  // ANYONE: GENERATE BANNED ACCOUNT
  // ----------------------------------------------------
  if (content === "$mcfa banned") {
    const account = data.banned.shift();
    if (!account)
      return message.reply("âŒâ€¯Noâ€¯bannedâ€¯accountsâ€¯available!");
    saveData(data);

    const embed = new EmbedBuilder()
      .setColor("#ff5555")
      .setTitle("ðŸŽ®â€¯Bannedâ€¯Minecraftâ€¯Account")
      .setDescription(
        `Heyâ€¯**${message.author.username}**,â€¯hereâ€™sâ€¯aâ€¯bannedâ€¯account:\n\n` +
          `>â€¯ðŸ“§â€¯**Email:**â€¯\`${account.email}\`\n` +
          `>â€¯ðŸ”â€¯**Password:**â€¯\`${account.password}\`\n\n` +
          "Theseâ€¯areâ€¯forâ€¯testingâ€¯orâ€¯practiceâ€¯onlyâ€¯â€”â€¯expectâ€¯themâ€¯toâ€¯beâ€¯bannedâ€¯onâ€¯officialâ€¯Minecraftâ€¯servers."
      )
      .setFooter({ text: "Providedâ€¯byâ€¯LoxYâ€¯Hubâ€¯â€¢â€¯useâ€¯wisely" });

    await message.author.send({ embeds: [embed] }).catch(() =>
      message.reply("ðŸ“¬â€¯Couldnâ€™tâ€¯DMâ€¯youâ€¯â€”â€¯enableâ€¯DMs!")
    );
    return message.reply("ðŸ“©â€¯Checkâ€¯yourâ€¯DMsâ€¯forâ€¯theâ€¯bannedâ€¯account!");
  }

  // ----------------------------------------------------
  // ADMIN: ADD NORMAL ACCOUNT
  // ----------------------------------------------------
  if (content.startsWith("$mcfa add ")) {
    if (message.author.id !== ADMIN_ID)
      return message.reply("ðŸš«â€¯Onlyâ€¯adminâ€¯canâ€¯addâ€¯accounts.");

    const args = content.split(" ");
    if (args.length < 4)
      return message.reply(
        "Usage:â€¯`$mcfaâ€¯addâ€¯emailâ€¯password`â€¯orâ€¯`$mcfaâ€¯addâ€¯Minecraft_bannedâ€¯emailâ€¯password`"
      );

    // distinguish between normal and banned
    if (args[2].toLowerCase() === "minecraft_banned") {
      const email = args[3];
      const password = args[4];
      data.banned.push({ email, password });
      saveData(data);
      return message.reply(
        `âœ…â€¯Addedâ€¯bannedâ€¯account:â€¯**${email}**â€¯toâ€¯bannedâ€¯list.`
      );
    } else {
      const email = args[2];
      const password = args[3];
      data.normal.push({ email, password });
      saveData(data);
      return message.reply(`âœ…â€¯Addedâ€¯normalâ€¯accountâ€¯forâ€¯**${email}**`);
    }
  }

  // ----------------------------------------------------
  // ADMIN: RESET LISTS
  // ----------------------------------------------------
  if (content === "$mcfa reset banned") {
    if (message.author.id !== ADMIN_ID)
      return message.reply("ðŸš«â€¯Onlyâ€¯adminâ€¯canâ€¯resetâ€¯bannedâ€¯accounts.");
    data.banned = [];
    saveData(data);
    return message.reply("ðŸ§¹â€¯Allâ€¯bannedâ€¯accountsâ€¯cleared!");
  }

  if (content === "$mcfa reset mcfa") {
    if (message.author.id !== ADMIN_ID)
      return message.reply("ðŸš«â€¯Onlyâ€¯adminâ€¯canâ€¯resetâ€¯normalâ€¯accounts.");
    data.normal = [];
    saveData(data);
    return message.reply("ðŸ§¹â€¯Allâ€¯normalâ€¯accountsâ€¯cleared!");
  }
});

client.login(process.env.TOKEN);